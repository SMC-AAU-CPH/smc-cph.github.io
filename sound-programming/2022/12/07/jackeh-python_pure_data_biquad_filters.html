<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Creating Complex Filters in Pure Data with Biquad~ | The SMC Blog</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Creating Complex Filters in Pure Data with Biquad~" />
<meta name="author" content="Jack Hardwick" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="One approach to building/rebuilding complex filters in Pure Data, with a little help from Python." />
<meta property="og:description" content="One approach to building/rebuilding complex filters in Pure Data, with a little help from Python." />
<link rel="canonical" href="https://smc-aau-cph.github.io/smc-cph.github.io/sound-programming/2022/12/07/jackeh-python_pure_data_biquad_filters.html" />
<meta property="og:url" content="https://smc-aau-cph.github.io/smc-cph.github.io/sound-programming/2022/12/07/jackeh-python_pure_data_biquad_filters.html" />
<meta property="og:site_name" content="The SMC Blog" />
<meta property="og:image" content="https://smc-aau-cph.github.io/smc-cph.github.io/assets/image/2022_12_07_jackeh_filters_blog_post_preview_image.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-12-07T20:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://smc-aau-cph.github.io/smc-cph.github.io/assets/image/2022_12_07_jackeh_filters_blog_post_preview_image.jpg" />
<meta property="twitter:title" content="Creating Complex Filters in Pure Data with Biquad~" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jack Hardwick"},"dateModified":"2022-12-07T20:00:00+00:00","datePublished":"2022-12-07T20:00:00+00:00","description":"One approach to building/rebuilding complex filters in Pure Data, with a little help from Python.","headline":"Creating Complex Filters in Pure Data with Biquad~","image":"https://smc-aau-cph.github.io/smc-cph.github.io/assets/image/2022_12_07_jackeh_filters_blog_post_preview_image.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://smc-aau-cph.github.io/smc-cph.github.io/sound-programming/2022/12/07/jackeh-python_pure_data_biquad_filters.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://smc-aau-cph.github.io/smc-cph.github.io/assets/image/2022_07_20_stefanof_SMC_logo_grey.png"},"name":"Jack Hardwick"},"url":"https://smc-aau-cph.github.io/smc-cph.github.io/sound-programming/2022/12/07/jackeh-python_pure_data_biquad_filters.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://smc-aau-cph.github.io/smc-cph.github.io/feed.xml" title="The SMC Blog" /></head>
<body><header class="site-header" role="banner"><div class="hamburger-menu-container">
  <nav>
    <ul>
      
      <li class="page-link-hamburger">
        

        <a href="#" class="drop-btn-hamburger" onclick="handleMenuClick(this)"
          >Topics</a
        >
        <ul class="dropdown-hamburger">
          
          <li><a href="/interactive-music/">New Interfaces for Musical Expression (NIME)</a></li>
          
          <li><a href="/machine-learning/">Machine Learning for Media Experiences</a></li>
          
          <li><a href="/motion-capture/">Embodied Interaction</a></li>
          
          <li><a href="/networked-music/">Networked Music</a></li>
          
          <li><a href="/sonification/">Sonification</a></li>
          
          <li><a href="/sound-programming/">Sound Processing</a></li>
          
          <li><a href="/spatial-audio/">Spatial User Interfaces</a></li>
          
          <li><a href="/other/">Other</a></li>
          
          <li><a href="/alltopics/">All Topics</a></li>
          
        </ul>

        
      </li>
      
      <li class="page-link-hamburger">
        

        <a href="#" class="drop-btn-hamburger" onclick="handleMenuClick(this)"
          >Projects</a
        >
        <ul class="dropdown-hamburger">
          
          <li><a href="/mini-projects/">Course Mini Projects</a></li>
          
          <li><a href="/applied-projects/">Semester Projects</a></li>
          
          <li><a href="/masters-thesis/">Master's Theses</a></li>
          
          <li><a href="/projects/">All Projects</a></li>
          
        </ul>

        
      </li>
      
      <li class="page-link-hamburger">
        
        <a href="/people/">People</a>
        
      </li>
      
      <li class="page-link-hamburger">
        
        <a href="/about/">About</a>
        
      </li>
      
      <li class="page-link-hamburger">
        
        <a href="/Guides/">Guides</a>
        
      </li>
      
      <li class="page-link-hamburger">
        
        <a href="/search/">Search</a>
        
      </li>
      
    </ul>
  </nav>
</div>
<div class="wrapper">
        <div class="title-and-logo-wrapper">
            <a href="/">
                <img class="site-logo" src="/assets/image/2022_07_20_stefanof_SMC_logo_grey.png" />
            </a>
            <p class="site-title">
            The SMC Blog
            </p>
        </div>

        <nav class="site-nav">
        <ul>
            
            <li class="page-link">
            

                <a href='#' class="drop-btn" onclick="handleMenuClick(this)">Topics</a>
                <ul class="dropdown">
                
                <li><a href="/interactive-music/">New Interfaces for Musical Expression (NIME)</a></li>
                
                <li><a href="/machine-learning/">Machine Learning for Media Experiences</a></li>
                
                <li><a href="/motion-capture/">Embodied Interaction</a></li>
                
                <li><a href="/networked-music/">Networked Music</a></li>
                
                <li><a href="/sonification/">Sonification</a></li>
                
                <li><a href="/sound-programming/">Sound Processing</a></li>
                
                <li><a href="/spatial-audio/">Spatial User Interfaces</a></li>
                
                <li><a href="/other/">Other</a></li>
                
                <li><a href="/alltopics/">All Topics</a></li>
                
                </ul>

            
            </li>
            
            <li class="page-link">
            

                <a href='#' class="drop-btn" onclick="handleMenuClick(this)">Projects</a>
                <ul class="dropdown">
                
                <li><a href="/mini-projects/">Course Mini Projects</a></li>
                
                <li><a href="/applied-projects/">Semester Projects</a></li>
                
                <li><a href="/masters-thesis/">Master's Theses</a></li>
                
                <li><a href="/projects/">All Projects</a></li>
                
                </ul>

            
            </li>
            
            <li class="page-link">
            
                <a href="/people/">People</a>
            
            </li>
            
            <li class="page-link">
            
                <a href="/about/">About</a>
            
            </li>
            
            <li class="page-link">
            
                <a href="/Guides/">Guides</a>
            
            </li>
            
            <li class="page-link">
            
                <a href="/search/">Search</a>
            
            </li>
            
        </ul>
        </nav>
        <nav class="hamburger-icon-nav"><div class="hamburger-icon-container" onclick="handleHamburgerClick(this)">
  <div class="hamburger-icon-div hamburger-bar1"></div>
  <div class="hamburger-icon-div hamburger-bar2"></div>
  <div class="hamburger-icon-div hamburger-bar3"></div>
</div>
</nav>
    </div>

  <script src="/utils/jquery.js"></script>
  <script src="/utils/hamburger-nav.js"></script>
  <script src="/utils/nav-dropdown-click-handler.js"></script>
</header>
<main class="page-content" aria-label="Content">

      <div class="wrapper">
        <article
  class="post h-entry"
  itemscope
  itemtype="http://schema.org/BlogPosting"
>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline" align="left">
      Creating Complex Filters in Pure Data with Biquad~
    </h1>
    <p class="post-meta">
      <time
        class="dt-published"
        datetime="2022-12-07T20:00:00+00:00"
        itemprop="datePublished"
      >Dec 7, 2022 •
      </time>
         
      <a href="/authors/jackhardwick.html">Jack Hardwick</a>
        </p>
  </header>

  <div class="post-content" itemprop="articleBody"><h2 id="an-brief-introduction-to-filters">An Brief Introduction to Filters</h2>

<p>Coffee filters and audio filters work on much the same principle. A coffee filter lets your lovely hot coffee through while preventing bits of bean from ending up in your oat milk flat white. Meanwhile digital filters let through some frequencies (the coffee) while holding back others (the coffee grounds). Audio filters are one of the key components of the computer musician’s toolbox. As musicians, we most commonly think of filtering as a component of mixing or sound design. However, a filter can be applied to any time series data, for example control signals in Max/MSP or Pure Data, physical sensor data, or even geological data or tidal data.</p>

<p>The most used filter types in musical contexts are low-pass, high-pass, band-pass, and band-stop, which work largely as the names suggest. However, one can also specify more complex filter shapes. For example, suppose we want to correct or ‘flatten’ the natural frequency response of a room or a pair of headphones. A simple low-pass filter is not going to be enough, as there are numerous frequencies that are either boosted or attenuated to different extents. As a result, we will need to employ a filter with a complex response to neutralise the peaks and valleys.</p>

<figure style="float: none">
   <img src="/assets/image/2022_12_07_jackeh_headphone_eq.jpg" alt="Headphone EQ" title="Headphone EQ" width="75%" />
   <figcaption>An example of a complex filter response in Sonarworks software, which aims to flatten the frequency response of my headphones.</figcaption>
</figure>

<h2 id="designing-complex-filters-in-python--pure-data">Designing Complex Filters in Python &amp; Pure Data</h2>

<p>Designing a complex filter in Python is made relatively straightforward using the <a href="https://docs.scipy.org/doc/scipy/reference/signal.html">Signal component in the SciPy library</a>. We simply call an appropriate function, specify our requirements, and the rest is taken care of under the hood. Meanwhile, the Pure Data graphical programming language offers some user-friendly objects for the common filter types mentioned above as well as some more daunting algorithms. However, it does not have a one-stop solution for building complex filters of the sort we can specify in Python. Instead we can ‘cascade’ several simpler filter shapes together to recreate a more complex response. For example, we can use low-pass and high-pass filters together to create a sufficient, if fairly imprecise, band-pass filter. For more precise filter requirements in Pure Data however, we can turn again to SciPy.</p>

<h2 id="recreating-a-python-filter-in-pure-data">Recreating a Python Filter in Pure Data</h2>

<p>SciPy’s handy tf2sos() function allows us to break down an IIR filter designed in Python using a function such as  into a series of simpler sections. Each of these second order sections, of which there can be many, can then be interpreted by a biquad~ filter in Pure Data to recreate our complex filter.</p>

<p>The tf2sos() function returns a list of lists of filter coefficients that define the frequency response of each section. Below is one approach to recreating in Pure data an IIR filter built with SciPy. It uses Python to run a terminal command which opens Pure Data and sends lists of filter coefficients to Pure Data receive objects. These lists which are the interpreted by multiple biquad filters to recreate the original complex filter. This approach allows for filters of IIR filters up to order 16 to be accurately recreated in Pure Data. A small amount of precision is lost in translation due to the difference in accuracy of floating point numbers between Python and Pure Data. However this is negligible for our audio examples below.</p>

<p>In Python I piece together a terminal command to open the Pure Data patch and pass the filter coefficients as lists using the <code>-send</code> command line option. This option allows me to send directly to ‘receive’ objects in Pure Data by simply providing the name of the receive and the data I want to send to it. In this case, lists of numbers are passed via receive objects to several biquad~ objects to recreate the filter, and the resulting sound is written to the specified audio file.</p>

<p>The Python code builds the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:/Program Files/Pd/bin/pd.exe -open tf2sos_biquad.pd -r 48000 -send "; sec1
0.7259912605703875 -0.0 0.03806324928680216 0.03806324928680211 0.0; sec2
1.7126604844375657 -0.7597960137277255 1.0 -1.8856873367725067 0.9999999999999819;
sec3 1.9117563444113768 -0.9417048830803751 1.0 -1.9555513841911991
1.000000000000015; input_file ./test_audio/to_be_filtered.wav; output_file
./test_audio/filtered_pd.wav"
</code></pre></div></div>

<p>The code that builds this command is:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__pd_build_command</span><span class="p">(</span><span class="n">sos_scaled</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Builds the command given the Numpy array of coefficients and
    the input and output filenames.</span><span class="sh">"""</span>
    
    <span class="c1"># Pd install directory
</span>    <span class="n">pd_executable</span> <span class="o">=</span> <span class="sh">"</span><span class="s">C:/Program Files/Pd/bin/pd.exe</span><span class="sh">"</span>
    <span class="n">pd_patch</span> <span class="o">=</span> <span class="sh">"</span><span class="s">tf2sos_biquad.pd</span><span class="sh">"</span> <span class="c1"># The Pd patch to open
</span>    
    <span class="c1"># Initialises empty list which will contains strings of coefficients
</span>    <span class="n">section_strings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Initialises string containing all sends
</span>    <span class="n">sends</span> <span class="o">=</span> <span class="sh">'</span><span class="s"> -send </span><span class="sh">"'</span> 

    <span class="n">coeff_order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># List of new order for coefficients
</span>
    <span class="c1"># Loops through the second order sections, which are all stored in a Numpy array
</span>    <span class="k">for</span> <span class="n">sec_i</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">sos_scaled</span><span class="p">):</span>
        <span class="n">coeff_string</span> <span class="o">=</span> <span class="sh">""</span> <span class="c1"># Initialising/resetting the string of coefficients
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coeff_order</span><span class="p">:</span> <span class="c1"># iterates through section in required order
</span>            <span class="c1"># Appends together the coefficients into a string
</span>            <span class="n">coeff_string</span> <span class="o">=</span> <span class="n">coeff_string</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span>
        
        <span class="c1"># Appends together Pd message for each section
</span>        <span class="n">section_string</span> <span class="o">=</span> <span class="sh">"</span><span class="s">; sec</span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">sec_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span> <span class="o">+</span> <span class="n">coeff_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 

        <span class="n">sends</span> <span class="o">=</span> <span class="n">sends</span> <span class="o">+</span> <span class="n">section_string</span> <span class="c1"># Builds up sends string from section_string
</span>
    <span class="c1"># Finishes sends string by adding input and output filenames
</span>    <span class="n">sends</span> <span class="o">=</span> <span class="n">sends</span> <span class="o">+</span> <span class="sh">"</span><span class="s">; input_file </span><span class="sh">"</span> <span class="o">+</span> <span class="n">input_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">; output_file </span><span class="sh">"</span> <span class="o">+</span> <span class="n">output_file</span> <span class="o">+</span> <span class="sh">'"'</span>

    <span class="c1"># Assembles the final command
</span>    <span class="n">command</span> <span class="o">=</span> <span class="n">pd_executable</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> -open </span><span class="sh">"</span> <span class="o">+</span> <span class="n">pd_patch</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> -r </span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="o">+</span> <span class="n">sends</span>
</code></pre></div></div>

<p>The command first opens the relevant Pure Data patch, sets the sample rate of the patch (48000, the same as I am working with in Python), and then sends lists of coefficients grouped into their sections. These are each received by their equivalent receive objects in Pure Data – the first section is received in ‘receive sec1’ in Pure Data, and so on. Lastly, I pass the path to the file to be filtered and where to save the filtered result. I can also add <code>-batch -nogui</code> to the command, which allows Pure Data to run offline i.e., not in real time and without opening the interface.</p>

<p>While this example only recreates a low-pass filter, this can be theoretically be replicated with any shape of IIR filter designed in SciPy Signal.</p>

<figure style="float: none">
   <img src="/assets/image/2022_12_07_jackeh_pd_patch.jpg" alt="Pure Data patch" title="Pure Data patch" width="75%" />
   <figcaption>The Pure Data patch which receives filter coefficients, filters the audio, and writes the output to a file.</figcaption>
</figure>

<p>One useful feature of this implementation is its ability to handle IIR filters of various different orders up to 16, which in most cases is a reasonable upper limit for IIR filter order. I included eight second order biquad filters in the Pure Data patch as a 16th order IIR filter was the highest I have encountered so far in Python. However, the tf2sos() function can decompose IIR filters of any order and likewise my Python function which builds the command can similarly handle any number of second order sections. The limiting factor here is the Pure Data patch, although this can be easily expanded to handle larger numbers of sections.</p>

<p>The audio files and spectrograms below demonstrate how both filtering methods produce perceptually identical results.</p>

<h3 id="audio-before-filtering">Audio before filtering</h3>

<figure style="float: none">
  <audio controls="">
    <source src="https://www.uio.no/english/studies/programmes/SMC-master/blog/assets/audio/2022_12_07_jackeh_sample_audio_unfiltered.wav" type="audio/mpeg" />
    Alternate Text
  </audio>
  <figcaption>The audio sample before filtering.</figcaption>
</figure>
<figure style="float: none">
   <img src="/assets/image/2022_12_07_jackeh_before_filter_spectrogram.png" alt="Unfiltered spectrogram" width="auto" />
</figure>

<h3 id="audio-filtered-in-python-using-scipy-signal">Audio filtered in Python using SciPy Signal</h3>

<figure style="float: none">
  <audio controls="">
    <source src="https://www.uio.no/english/studies/programmes/SMC-master/blog/assets/audio/2022_12_07_jackeh_sample_audio_filtered_python.wav" type="audio/mpeg" />
    Alternate Text
  </audio>
  <figcaption>The audio sample filtered using SciPy Signal.</figcaption>
</figure>
<figure style="float: none">
   <img src="/assets/image/2022_12_07_jackeh_filter_python_spectrogram.png" alt="Filtered with Python spectrogram" width="auto" />
</figure>

<h3 id="audio-filtered-in-pure-data-using-several-biquad-filter-in-cascade">Audio filtered in Pure Data using several biquad~ filter in cascade</h3>

<figure style="float: none">
  <audio controls="">
    <source src="https://www.uio.no/english/studies/programmes/SMC-master/blog/assets/audio/2022_12_07_jackeh_sample_audio_filtered_pd.wav" type="audio/mpeg" />
    Alternate Text
  </audio>
  <figcaption>The audio sample filtered by the same filter recreated in Pure Data.</figcaption>
</figure>
<figure style="float: none">
   <img src="/assets/image/2022_12_07_jackeh_filter_pd_spectrogram.png" alt="Filtered with Pure Data spectrogram" width="auto" />
</figure>

<h2 id="downloads">Downloads</h2>

<p>Download the Jupyter Notebook, Pure Data patch, and audio files discussed above from GitHub <a href="https://github.com/hathuwic/Python_PureData_filter">here</a>.</p>

</div>

  

  <a class="u-url" href="/sound-programming/2022/12/07/jackeh-python_pure_data_biquad_filters.html" hidden></a>
</article>

<script src="/utils/slideshow.js"></script>
<script src="https://unpkg.com/wavesurfer.js@5.0.1/dist/wavesurfer.js"></script>
<script src="/utils/waveform.js"></script>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">The SMC Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">The SMC Blog</li><li><a class="u-email" href="mailto:cer@create.aau.dk">cer@create.aau.dk</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/smc-aau-cph"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">smc-aau-cph</span></a></li><li><a href="https://www.twitter.com/smc-aau-cph"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">smc-aau-cph</span></a></li><li><a href="https://youtube.com/c/smc-aau-cphr/videos"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">SMC_master</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>RSS feed</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>The student-led blog of the Aalborg University Copenhagen (AAU-CPH) master&#39;s programme in Sound and Music Computing (SMC).</p>
      </div>
    </div>

  </div>

</footer>


    <!-- include comments here -->

  </body>

</html>
