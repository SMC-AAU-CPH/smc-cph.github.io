<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Learning to sequence drums | The SMC Blog</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Learning to sequence drums" />
<meta name="author" content="Ulrik Halmøy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Can reinforcement learning be a useful tool to teach a neural network to sequence drums?" />
<meta property="og:description" content="Can reinforcement learning be a useful tool to teach a neural network to sequence drums?" />
<link rel="canonical" href="https://smc-aau-cph.github.io/smc-cph.github.io/machine-learning/2020/09/21/reinforcement-learning-drum-sequences.html" />
<meta property="og:url" content="https://smc-aau-cph.github.io/smc-cph.github.io/machine-learning/2020/09/21/reinforcement-learning-drum-sequences.html" />
<meta property="og:site_name" content="The SMC Blog" />
<meta property="og:image" content="https://smc-aau-cph.github.io/smc-cph.github.io/assets/image/2020_09_21_ulrikah_reinforcement_learning.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-21T06:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://smc-aau-cph.github.io/smc-cph.github.io/assets/image/2020_09_21_ulrikah_reinforcement_learning.jpg" />
<meta property="twitter:title" content="Learning to sequence drums" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ulrik Halmøy"},"dateModified":"2020-09-21T06:00:00+00:00","datePublished":"2020-09-21T06:00:00+00:00","description":"Can reinforcement learning be a useful tool to teach a neural network to sequence drums?","headline":"Learning to sequence drums","image":"https://smc-aau-cph.github.io/smc-cph.github.io/assets/image/2020_09_21_ulrikah_reinforcement_learning.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://smc-aau-cph.github.io/smc-cph.github.io/machine-learning/2020/09/21/reinforcement-learning-drum-sequences.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://smc-aau-cph.github.io/smc-cph.github.io/assets/image/2022_07_20_stefanof_SMC_logo_grey.png"},"name":"Ulrik Halmøy"},"url":"https://smc-aau-cph.github.io/smc-cph.github.io/machine-learning/2020/09/21/reinforcement-learning-drum-sequences.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://smc-aau-cph.github.io/smc-cph.github.io/feed.xml" title="The SMC Blog" /></head>
<body><header class="site-header" role="banner"><div class="hamburger-menu-container">
  <nav>
    <ul>
      
      <li class="page-link-hamburger">
        

        <a href="#" class="drop-btn-hamburger" onclick="handleMenuClick(this)"
          >Topics</a
        >
        <ul class="dropdown-hamburger">
          
          <li><a href="/interactive-music/">New Interfaces for Musical Expression (NIME)</a></li>
          
          <li><a href="/machine-learning/">Machine Learning for Media Experiences</a></li>
          
          <li><a href="/motion-capture/">Embodied Interaction</a></li>
          
          <li><a href="/networked-music/">Networked Music</a></li>
          
          <li><a href="/sonification/">Sonification</a></li>
          
          <li><a href="/sound-programming/">Sound Processing</a></li>
          
          <li><a href="/spatial-audio/">Spatial User Interfaces</a></li>
          
          <li><a href="/other/">Other</a></li>
          
          <li><a href="/alltopics/">All Topics</a></li>
          
        </ul>

        
      </li>
      
      <li class="page-link-hamburger">
        

        <a href="#" class="drop-btn-hamburger" onclick="handleMenuClick(this)"
          >Projects</a
        >
        <ul class="dropdown-hamburger">
          
          <li><a href="/mini-projects/">Course Mini Projects</a></li>
          
          <li><a href="/applied-projects/">Semester Projects</a></li>
          
          <li><a href="/masters-thesis/">Master's Theses</a></li>
          
          <li><a href="/projects/">All Projects</a></li>
          
        </ul>

        
      </li>
      
      <li class="page-link-hamburger">
        
        <a href="/people/">People</a>
        
      </li>
      
      <li class="page-link-hamburger">
        
        <a href="/about/">About</a>
        
      </li>
      
      <li class="page-link-hamburger">
        
        <a href="/Guides/">Guides</a>
        
      </li>
      
      <li class="page-link-hamburger">
        
        <a href="/search/">Search</a>
        
      </li>
      
    </ul>
  </nav>
</div>
<div class="wrapper">
        <div class="title-and-logo-wrapper">
            <a href="/">
                <img class="site-logo" src="/assets/image/2022_07_20_stefanof_SMC_logo_grey.png" />
            </a>
            <p class="site-title">
            The SMC Blog
            </p>
        </div>

        <nav class="site-nav">
        <ul>
            
            <li class="page-link">
            

                <a href='#' class="drop-btn" onclick="handleMenuClick(this)">Topics</a>
                <ul class="dropdown">
                
                <li><a href="/interactive-music/">New Interfaces for Musical Expression (NIME)</a></li>
                
                <li><a href="/machine-learning/">Machine Learning for Media Experiences</a></li>
                
                <li><a href="/motion-capture/">Embodied Interaction</a></li>
                
                <li><a href="/networked-music/">Networked Music</a></li>
                
                <li><a href="/sonification/">Sonification</a></li>
                
                <li><a href="/sound-programming/">Sound Processing</a></li>
                
                <li><a href="/spatial-audio/">Spatial User Interfaces</a></li>
                
                <li><a href="/other/">Other</a></li>
                
                <li><a href="/alltopics/">All Topics</a></li>
                
                </ul>

            
            </li>
            
            <li class="page-link">
            

                <a href='#' class="drop-btn" onclick="handleMenuClick(this)">Projects</a>
                <ul class="dropdown">
                
                <li><a href="/mini-projects/">Course Mini Projects</a></li>
                
                <li><a href="/applied-projects/">Semester Projects</a></li>
                
                <li><a href="/masters-thesis/">Master's Theses</a></li>
                
                <li><a href="/projects/">All Projects</a></li>
                
                </ul>

            
            </li>
            
            <li class="page-link">
            
                <a href="/people/">People</a>
            
            </li>
            
            <li class="page-link">
            
                <a href="/about/">About</a>
            
            </li>
            
            <li class="page-link">
            
                <a href="/Guides/">Guides</a>
            
            </li>
            
            <li class="page-link">
            
                <a href="/search/">Search</a>
            
            </li>
            
        </ul>
        </nav>
        <nav class="hamburger-icon-nav"><div class="hamburger-icon-container" onclick="handleHamburgerClick(this)">
  <div class="hamburger-icon-div hamburger-bar1"></div>
  <div class="hamburger-icon-div hamburger-bar2"></div>
  <div class="hamburger-icon-div hamburger-bar3"></div>
</div>
</nav>
    </div>

  <script src="/utils/jquery.js"></script>
  <script src="/utils/hamburger-nav.js"></script>
  <script src="/utils/nav-dropdown-click-handler.js"></script>
</header>
<main class="page-content" aria-label="Content">

      <div class="wrapper">
        <article
  class="post h-entry"
  itemscope
  itemtype="http://schema.org/BlogPosting"
>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline" align="left">
      Learning to sequence drums
    </h1>
    <p class="post-meta">
      <time
        class="dt-published"
        datetime="2020-09-21T06:00:00+00:00"
        itemprop="datePublished"
      >Sep 21, 2020 •
      </time>
         
      <a href="/authors/ulrikhalmoy.html">Ulrik Halmøy</a>
        </p>
  </header>

  <div class="post-content" itemprop="articleBody"><h1 id="sequencing-drums-with-reinforcement-learning">Sequencing drums with reinforcement learning</h1>

<p>The motivation for this project was to start to explore interactive use of machine learning in music, with the intention to continue the work in my master thesis. The specific goal of this project has been to train a neu- ral network to respond to incoming MIDI sequences of one instrument with appropriate MIDI sequences of another instrument.</p>

<p>The background for the idea was a personal desire for a system that could be able to respond to choices I make in my digital music production. Often, I find myself sampling from a variety of different random functions to produce interesting parameter combinations or patterns. However, I generally have to make quite a few attempts before finding something that sounds meaningful.</p>

<p>In this project I wanted to figure out if it was possible to create a software that could do a bit better than random, to augment the human-computer interaction in a production setting.</p>

<p><strong>Source code: <a href="https://github.com/ulrikah/rave">https://github.com/ulrikah/rave</a></strong></p>

<hr />

<h2 id="reinforcement-learning">Reinforcement learning</h2>

<p>To tackle the problem at hand, I decided to apply techniques from <em>reinforcement learning</em>, a form of machine learning that I have been wanting to learn more about for some time. Reinforcement learning is concerned with learning software <em>agents</em> an <em>action policy</em> that they should use to act in an <em>environment</em> with the goal of maximizing a cumulative <em>reward</em>. The reward is given by the environment in which the agent is acting. One example of reinforcement learning could be a game in which a software agent learns to play tic-tac-toe against a human opponent only by evaluating the reward (e.g. 1 for victory and 0 for loss) after repeated rounds of playing with a human agent. For a game such as tic-tac-toe, in which both the action space and the observation space are small and discrete sets, iterating through all the game states and calculating the optimal policy is a trivial task. In more complex environments, it can be either impossible or too computationally expensive to derive the policy explicitly. In such scenarios, neural networks can be used as approximators for the policy function, since they have the property of being universal function approximators [4]. This has led to recent breakthroughs for the field of reinforcement learning, such as the ability to learn agents to play several Atari games only by looking at the raw pixel values [5].</p>

<h2 id="implementation">Implementation</h2>

<p>The code for the project can be found at: <a href="https://github.com/ulrikah/rave">https://github.com/ulrikah/rave</a>. After installing the dependencies in <code class="language-plaintext highlighter-rouge">conda.yml</code>, training the model can be done by executing</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">main</span><span class="p">.</span><span class="n">py</span> <span class="n">train</span>
</code></pre></div></div>

<p>This produces a checkpoint in the <code class="language-plaintext highlighter-rouge">checkpoints/</code> folder. Subsequent testing of the model can be done by running</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">main</span><span class="p">.</span><span class="n">py</span> <span class="n">test</span> <span class="o">--</span><span class="n">checkpoint</span> <span class="n">checkpoints</span><span class="o">/&lt;</span><span class="n">checkpoint</span><span class="o">&gt;</span>
</code></pre></div></div>

<h3 id="modelling-the-environment">Modelling the environment</h3>

<p>Trying to build a custom reinforcement learning system comes with the cost of having to design and develop and environment in which your agent can act. To build the environment, I created a class which inherits from <code class="language-plaintext highlighter-rouge">gym.Env</code> (see the <code class="language-plaintext highlighter-rouge">gym</code> <a href="https://gym.openai.com/">docs</a>) and implements the required methods and properties.</p>

<p>The environment I built is more conceptual than the typical <code class="language-plaintext highlighter-rouge">gym</code> game environments. At its core, it has a function for calculating the reward given a <code class="language-plaintext highlighter-rouge">(state, action)</code> pair, and a function called <code class="language-plaintext highlighter-rouge">step</code> for performing iterations and updating its internal state. It also has a <code class="language-plaintext highlighter-rouge">render</code> function which simply prints the sequence as a string. However, <code class="language-plaintext highlighter-rouge">render</code> is supposed to be extended with some functionality for converting the binary sequence to MIDI and doing I/O operations over a MIDI port.</p>

<p>The metric I used to calculate the reward was simply defined as the normalised sum of the absolute difference between the two patterns. As an example, given the following inputs:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x o o o x o o o x o o o x o o o <span class="o">[</span>kick]
o x x x o x x x o x x x o x x x <span class="o">[</span>snare]
</code></pre></div></div>

<p>the environment yields the maximum reward of 1.0. In other words, for most of the time I tried to make the network learn the snare pattern above. This metric is in itself not interesting in a machine learning context, since it would be easy to define a much simpler algorithm to optimize the program to generate such sequences. However, it was very useful to work with a simple metric to evaluate whether or not the network learned the way I hoped it would.</p>

<p>I wanted to test out a variety of metrics in my project, but I didn’t get that far. I would like to try implement at least one of the techniques from Shmulevich and Povel [7] to incorporate a metric of rhythmic complexity. In that way, given a kick pattern as input, I could potentially be able to learn a neural network to play the most complicated appropriate snare pattern as the output.</p>

<h2 id="evaluation">Evaluation</h2>

<p>To evaluate my model, I made a script that would run <em>n</em> iterations of the environments <code class="language-plaintext highlighter-rouge">step</code> function and blindly take the <em>argmax</em> of the <a href="https://en.wikipedia.org/wiki/Softmax_function"><em>softmax</em></a> output the neural network as the action. The softmax activation function returns a probability distribution over the different steps in the sequence. Taking the argmax of softmax just means picking the step in the sequence that the neural network has given the highest probability for. During training of the network, I sampled from the softmax distribution in order to explore different options.</p>

<p>Considering that my network only can toggle one step at a time, it should take some iterations before it finds the optimal sequence.</p>

<p>I created two test scenarios which should yield rewards in the two extremes of the reward range (−1, 1) according to the metric I used. In both scenarios, the kick sequence is initialized to the standard 4/4 sequence.</p>

<p>The model that I used to test here was trained for 300 episodes.</p>

<h3 id="best-case-scenario">Best case scenario</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x o o o x o o o x o o o x o o o <span class="o">[</span>kick]
o x x x o x x x o x x x o x x x <span class="o">[</span>snare]
</code></pre></div></div>

<p>This scenario yields the maximum reward of 1.0 by default. This means that the network hopefully should avoid modifying the snare sequence, as it is already in its most optimal state. This very model was trained without the option to <em>avoid toggling</em> (i.e. by only outputting values for each of the 8 on/off steps in the snare sequence). As a consequence, it is expected that the network oscillates between the rewards 0.75 and 1.0.</p>

<p>Figure 1 demonstrates that the network is able to avoid modifying an optimal sequence, which is what we wanted. And interesting side effect is that the network only uses one of the steps to toggle on/off (a bit difficult to see in the graph). It may seem like the network has learned that if it is in a balanced state, it should only toggle one of the steps repeatedly.</p>

<figure align="middle">
   <img src="/assets/image/2020_09_21_ulrikah_best_sequence.jpg" width="auto" height="auto" />
   <figcaption>Fig. 1: Reward over 10 iterations for the best possible sequence as input </figcaption>
</figure>

<h3 id="worst-case-scenario">Worst case scenario</h3>

<p>In the worst case scenario, I initialize the snare sequence to be equal to the kick sequence:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x o o o x o o o x o o o x o o o <span class="o">[</span>kick]
x o o o x o o o x o o o x o o o <span class="o">[</span>snare]
</code></pre></div></div>

<p>The expected result of this scenario is that the network is able to modify the sequence into a sequence that ends up yielding rewards 0.75 and 1.0.</p>

<p>Figure 2 shows 10 forward passes through the network. The network manages to modify the snare sequence into a sequence that yields positive results very fast. After it has reached the optimal state, we can see the same oscillation between 0.75 and 1.0 that we observe in figure 1.</p>

<figure align="middle">
   <img src="/assets/image/2020_09_21_ulrikah_worst_sequence.jpg" width="auto" height="auto" />
   <figcaption>Fig. 2: Reward over 10 iterations for the worst possible sequence as input </figcaption>
</figure>

<h2 id="reflection">Reflection</h2>

<p>Throughout the project, I spent a lot of time trying to understand why the neural network I created failed to learn the representation I wanted it to learn.</p>

<p>At the very end of the project, I realized that I was only considering the average reward per episode as the metric of performance. This doesn’t make much sense given that I initialized the snare sequence randomly every time I reset the environment, which was done at the start of every episode. The problem with this approach is that it doesn’t measure how well the network performs in terms of <em>correcting</em> a <em>bad</em> sequence. Looking back, I probably should have measured the <em>delta reward</em> per episode, i.e. if the episode yielded a more positive reward at the end of the episode than at the beginning.</p>

<h3 id="future-work">Future work</h3>

<p>Future work on this project will involve exploring other metrics for defining the reward. I think an ideal solution would be to have the reward be defined by some weighted sum of multiple metrics, one of them being for instance to look at rhythmic complexity. In a production scenario, it would be interesting to let the user define which metrics that the agent should learn from, and this might be parameters that the musician could play with in a live context.</p>

<p>The system as it is today don’t render the binary sequences in a meaningful way. There is no formal relation to MIDI in the code, which obviously is something I would need to work on. Some of the next steps would be to formalize the agents a bit more, and integrate them with existing MIDI libraries such as <code class="language-plaintext highlighter-rouge">pretty-midi</code> or <code class="language-plaintext highlighter-rouge">mido</code>.
I would also need to design the algorithm more carefully to allow for flexible sequence lengths. One idea could be to train the network on long sequences (e.g. 512 or 1024 notes), and to do some smart resampling of shorter sequences.</p>

<p>Exploring how to extend this program to multiple voices would also be interest- ing to look at. Ideally, I would like to have multiple agents all learning from each other in a swarm-like manner to investigate what those sort of interations might produce. For this purpose, looking at Multi-Agent Actor-Critic [12] might be interesting.</p>

<p>At last, the system would need to be redesigned in a way that makes it applicable. This would potentially mean to export the model into something that could be read by other environments, and e.g. use it as part of a Juce or Max plugin (through Node For Max) in Ableton Live.</p>

<h2 id="references">References</h2>

<ol>
  <li>Qichao Lan, Jim Tørresen, and Alexander Refsum Jensenius. RaveForce: A Deep Reinforcement Learning Environment for Music. In Proceedings of the SMC Conferences, pages 217–222. Society for Sound and Music Computing, 2019.</li>
  <li>Francisco Bernardo, Chris Kiefer, and Thor Magnusson. An AudioWorklet- based Signal Engine for a Live Coding Language Ecosystem. In Proceedings of Web Audio Conference (WAC-2019).</li>
  <li>Lonce Wyse. Mechanisms of Artistic Creativity in Deep Learning Neural Networks. arXiv preprint arXiv:1907.00321, 2019.</li>
  <li>Michael A. Nielsen. Neural networks and deep learning, volume 25. Deter- mination press San Francisco, CA, USA:, 2015.</li>
  <li>Volodymyr Mnih, Koray Kavukcuoglu, David Silver, Alex Graves, Ioannis Antonoglou, Daan Wierstra, and Martin Riedmiller. Playing Atari with deep reinforcement learning. arXiv preprint arXiv:1312.5602, 2013.</li>
  <li>Muhan Li. Machin. https://github.com/iffiX/machin, 2020.</li>
  <li>Ilya Shmulevich and D.-J. Povel. Rhythm complexity measures for music pattern recognition. In 1998 IEEE Second Workshop on Multimedia Signal Processing (Cat. No. 98EX175), pages 167–172. IEEE, 1998.</li>
  <li>Adam Paszke. Reinforcement learning DQN tutorial. https://pytorch. org/tutorials/intermediate/reinforcement_q_learning.html, 2020.</li>
  <li>Chris Yoon. deep-q-networks. https://github.com/cyoon1729/ deep-Q-networks, 2019.</li>
  <li>Greg Brockman, Vicki Cheung, Ludwig Pettersson, Jonas Schneider,
John Schulman, Jie Tang, and Wo jciech Zaremba. Op enAI Gym. arXiv:1606.01540 cs., June 2016. arXiv: 1606.01540.</li>
  <li>Adam Paszke, Sam Gross, Francisco Massa, Adam Lerer, James Bradbury, Gregory Chanan, Trevor Killeen, Zeming Lin, Natalia Gimelshein, Luca Antiga, Alban Desmaison, Andreas Kopf, Edward Yang, Zachary DeVito, Martin Raison, Alykhan Tejani, Sasank Chilamkurthy, Benoit Steiner, Lu Fang, Junjie Bai, and Soumith Chintala. Pytorch: An imperative style, high-performance deep learning library. In H. Wallach, H. Larochelle, A. Beygelzimer, F. d’Alch ́e-Buc, E. Fox, and R. Garnett, editors, Advances in Neural Information Processing Systems 32, pages 8024–8035. Curran Associates, Inc., 2019.</li>
  <li>Ryan Lowe, Yi I. Wu, Aviv Tamar, Jean Harb, OpenAI Pieter Abbeel, and Igor Mordatch. Multi-agent actor-critic for mixed cooperative-competitive environments. In Advances in neural information processing systems, pages 6379–6390, 2017.</li>
</ol>
</div>

  

  <a class="u-url" href="/machine-learning/2020/09/21/reinforcement-learning-drum-sequences.html" hidden></a>
</article>

<script src="/utils/slideshow.js"></script>
<script src="https://unpkg.com/wavesurfer.js@5.0.1/dist/wavesurfer.js"></script>
<script src="/utils/waveform.js"></script>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">The SMC Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">The SMC Blog</li><li><a class="u-email" href="mailto:cer@create.aau.dk">cer@create.aau.dk</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/smc-aau-cph"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">smc-aau-cph</span></a></li><li><a href="https://www.twitter.com/smc-aau-cph"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">smc-aau-cph</span></a></li><li><a href="https://youtube.com/c/smc-aau-cphr/videos"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">SMC_master</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>RSS feed</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>The student-led blog of the Aalborg University Copenhagen (AAU-CPH) master&#39;s programme in Sound and Music Computing (SMC).</p>
      </div>
    </div>

  </div>

</footer>


    <!-- include comments here -->

  </body>

</html>
